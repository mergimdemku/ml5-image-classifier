<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bilderkennung mit ml5.js</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let classifier;
    let userChart;

    window.addEventListener('DOMContentLoaded', () => {
      classifier = ml5.imageClassifier('MobileNet', () => {
        document.getElementById('status').innerText = "Modell geladen. Du kannst jetzt ein Bild hochladen.";

        // Beispielbilder klassifizieren, sobald Modell geladen ist
        document.querySelectorAll('.example-img').forEach(img => {
          classifyExample(img);
        });
      });
    });

    function handleFile(input) {
      const file = input.files[0];
      if (!file) return;

      const imgElement = document.getElementById('user-image');
      imgElement.src = URL.createObjectURL(file);
      imgElement.onload = () => classifyImage(imgElement);
    }

    function classifyImage(imgElement) {
      classifier.classify(imgElement, (err, results) => {
        if (err) {
          console.error(err);
          return;
        }
        displayResults(results);
      });
    }

    function displayResults(results) {
      const labels = results.map(r => String(r.label));
      const confidences = results.map(r => Math.round(Number(r.confidence) * 100));

      const ctx = document.getElementById('userChart').getContext('2d');
      if (userChart) userChart.destroy();
      userChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Confidence (%)',
            data: confidences,
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          }
        }
      });
    }

    function classifyExample(imgElement) {
      if (!classifier) {
        console.warn("Modell noch nicht bereit.");
        return;
      }

      classifier.classify(imgElement, (err, results) => {
        if (err) {
          console.error(err);
          return;
        }
        console.log("Klassifikationsergebnis:", results);
        const canvas = imgElement.nextElementSibling;
        const ctx = canvas.getContext("2d");
        const label = results[0].label;
        const confidence = Math.round(results[0].confidence * 100);

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: [label],
            datasets: [{
              label: 'Confidence (%)',
              data: [confidence],
              backgroundColor: 'rgba(75, 192, 192, 0.7)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 100
              }
            }
          }
        });
      });
    }
  </script>
</head>
<body>
  <main>
    <h1>Bilderkennung (Klassifikation) mit ml5.js</h1>
    <p id="status">Modell wird geladen...</p>

    <section class="examples">
      <h2>Korrekt klassifizierte Bilder</h2>
      <div class="grid">
        <div>
          <img src="images/apple.jpg" alt="apple" class="example-img">
          <canvas></canvas>
        </div>
        <div>
          <img src="images/laptop.jpg" alt="laptop" class="example-img">
          <canvas></canvas>
        </div>
        <div>
          <img src="images/dog.jpg" alt="dog" class="example-img">
          <canvas></canvas>
        </div>
      </div>

      <h2>Falsch klassifizierte Bilder</h2>
      <div class="grid">
        <div>
          <img src="images/wrong1.jpg" alt="wrong1" class="example-img">
          <canvas></canvas>
        </div>
        <div>
          <img src="images/wrong2.jpg" alt="wrong2" class="example-img">
          <canvas></canvas>
        </div>
        <div>
          <img src="images/wrong3.jpg" alt="wrong3" class="example-img">
          <canvas></canvas>
        </div>
      </div>
    </section>

    <section class="user-upload">
      <h2>Eigenes Bild hochladen</h2>
      <div class="row">
        <div class="column">
          <input type="file" accept="image/*" onchange="handleFile(this)" />
          <img id="user-image" width="300" />
        </div>
        <div class="column">
          <canvas id="userChart" width="400" height="300"></canvas>
        </div>
      </div>
    </section>

    <section class="discussion">
      <h2>Diskussion</h2>
      <p>Die Bilderkennung mit MobileNet zeigte bei gut beleuchteten, klaren Bildern sehr hohe Genauigkeit. Beispielsweise wurde ein Hund, ein Laptop und ein Apfel korrekt erkannt. Bei Bildern mit ungewöhnlichen Winkeln, verdeckten Objekten oder verfremdeten Farben kam es jedoch zu Fehlklassifikationen. Die Confidence-Werte waren bei korrekten Bildern meist über 80 %, bei falschen deutlich darunter. Die Klassifikation ist stark abhängig von den Trainingsdaten des Modells und den visuellen Merkmalen des Bildes. Besonders bei künstlich bearbeiteten Bildern ließ die Zuverlässigkeit nach. Für den Einsatz in realen Anwendungen sollte die Bildqualität beachtet und ggf. mit anderen Modellen verglichen werden.</p>
    </section>
  </main>
</body>
</html>
